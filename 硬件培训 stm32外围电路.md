# stm32外围电路解析

## 复位电路

复位 ：让[MCU](https://so.csdn.net/so/search?q=MCU&spm=1001.2101.3001.7020)回到最开始的状态。并且从头开始，重新执行程序。（主要做的就是初始化每个寄存器，包括最重要的 PC 指针，不包括 RAM，然后单片机从复位地址开始执行程序。）

STM32的单片机，如Cortex-M3内核的单片机是低电平复位的单片机由STM32的数据手册可知，复位管脚低电平电压需要小于0.8V，输入脉冲时间为100ns。所以只需要在NRST管脚给小于0.8V的电压，持续时间为100ns就可以实现复位了。

需要注意的是，100ns时间是很短的，很容易达到， 但是如果只给100ns，那么此时是有复位信号了， 但是电源还没到VCC，晶振还没起振，因为上电时，Vcc 的上升时间约为 10ms，而振荡器的起振时间取决于振荡频率，如晶振频率为 10MHz，起振时间为 1ms；晶振频率为 1MHz，起振时间则为 10ms，而32kHz的晶振的启动时间一般要1～5秒。目前STM32单片机大部分采用8M高速晶振，那么主要问题出在电源的上升时间，为了保证系统的稳定性， 这里我们去2倍吧，20ms的低电平时间。

### 上电自动复位电路  RC充电电路

![image-20231026205801171](C:\Users\27142\AppData\Roaming\Typora\typora-user-images\image-20231026205801171.png)



其中A为低电平复位电路，常用于stm32

B为高电平复位电路，常用于51单片机等

### 手动复位电路

由于电容在上电充电完成后不会放电，故想要在上电时复位mcu，只需在电容两端并联一个轻触开关即可。

![image-20231026211313833](C:\Users\27142\AppData\Roaming\Typora\typora-user-images\image-20231026211313833.png)

其中100R电阻用于限流。

## 晶振电路

### 基本电路

![image-20231026211534110](C:\Users\27142\AppData\Roaming\Typora\typora-user-images\image-20231026211534110.png)

比较常用的是无源晶振，电路较为简单，只需用两个电容将晶振的脚引到GND，再将晶振的两脚分别与MCU的OSC_OUT和OSC_IN脚相连。

### 电容匹配

晶振电路设计的关键即在电容匹配上，其核心是确定上图C10和C11的大小，为了计算方便和保持晶体的负载平衡，一般取C10=C11（即CL1=CL2)



$$
C_L=\frac{C_{L1}C_{L2}}{C_{L1}+C_{L2}}+C_{stray}
$$
CL为晶振的负载电容，通过查询所用晶振的芯片手册获得

![image-20231026212754395](C:\Users\27142\AppData\Roaming\Typora\typora-user-images\image-20231026212754395.png)

Cstray为电路板的寄生电容，经验值为3-5pF。带入公式即可计算匹配电容大小，需要注意的是，有些公式考虑的更为全面，参数还纳入了PCB走线电容，MCU管脚电容等等，但在初期我们不考虑这些。

如果一点都不想算，那么可以考虑用经验值22pF，相当一部分的晶振的匹配电容都是这么多。

### 32.768KHz晶振

某些芯片需要实际时间作为时间基准，那么就需要32.768KHZ晶振作为外部时钟源

注意到2^15 = 32768 = 32.768K，2的15次方正好等于32768，反过来讲，如果要把32.768K的时钟频率经过15次二分频的话，得到的频率正好是1Hz，正好就是1秒钟时间，这样就可以计时了。至于为什么用32.768k而不是其他的2的幂次，是因为32.768K是石英压电效应的自然频率，不可改变，能与2的15次方对应，这样的发现可以说是个巧合，这样后期的运算电路可以设计的很简单，就会占用更少的内存和功耗。想找一个代替品很难。

另外，不建议使用有源晶振，相对于无源晶体，有源晶振的缺陷是其信号电平是固定的，需要选择好合适输出电平，灵活性较差，而且价格高。

## 供电电路

一般单片机所需的电压为3.3V，所需驱动电流不太大，可以考虑使用经典的LDO降压电路，常用的是1117

![image-20231026214510191](C:\Users\27142\AppData\Roaming\Typora\typora-user-images\image-20231026214510191.png)

这只是最简单的电路，如果是需要大驱动流（>1A),则需选取其他设计，如选用DCDC降压芯片或自己搭一个buck电路等。

## I2C电路设计

### I2C总线拓扑图

![image-20231026231711389](硬件培训 stm32外围电路.assets/image-20231026231711389.png)

总线特征表长这样，查表自行百度

![img](硬件培训 stm32外围电路.assets/58ee3d6d55fbb2fb73408a169ece6eae4723dcde.jpeg)

### I2C器件内部结构

漏极开路（Open Drain）即高阻状态，适用于输入/输出，其可独立输入/输出低电平和高阻状态，若需要产生高电平，则需使用外部上拉电阻

高阻状态：高阻状态是三态门电路的一种状态。逻辑门的输出除有高、低电平两种状态外，还有第三种状态——高阻状态的门电路。电路分析时高阻态可做开路理解。

为了避免总线信号的混乱，IIC的空闲状态只能有外部上拉， 而此时空闲设备被拉到了高阻态，也就是相当于断路， 整个IIC总线只有开启了的设备才会正常进行通信，而不会干扰到其他设备。

![image-20231026232152305](硬件培训 stm32外围电路.assets/image-20231026232152305.png)

**IIC器件地址**： 每一个IIC器件都有一个器件地址，有的器件地址在出厂时地址就设定好了，用户不可以更改,比如OV7670的地址为0x42。有的器件例如EEPROM，前四个地址已经确定为1010，后三个地址是由硬件链接确定的，所以一IIC总线最多能连8个EEPROM芯片。

### 上拉电阻的取值 max

#### 图像法 

即用用Rp（max）和Cb函数关系图求上拉电阻Rp（max）

![image-20231026220342872](C:\Users\27142\AppData\Roaming\Typora\typora-user-images\image-20231026220342872.png)

总线电容Cb是器件引脚、连接导线的总电容,总线100k速率可以使用的容限在10pF-400pF之间，400k速率可以使用的总线容限10pF-200pF之间。控制总线电容主要是控制连接在同一总线的器件数量。。在上升时间(tr)一定的情况下，此电容限制了上拉电阻Rp的最大值。知道Cb直接对着图查Rp。

#### 计算法

 用电容充电公式求上拉电阻Rp（max）
$$
v = V_F(1-e^{\frac{-t}{RC}})
$$

$$
v(t)=VDD(1-e^{\frac{-t}{RC}})
$$

其中t是充电时间，RC是时间常数。

电容充到0.3VDD的时间：
$$
v(t1)=0.3VDD=VDD(1-e^{\frac{-t}{RC}} )
$$

$$
则t1=0.3566749RC
$$

电容充到0.7VDD的时间：
$$
v(t2)=0.7VDD=VDD(1-e^{\frac{-t}{RC}} )
$$

$$
t2 = 1.2039729RC
$$

上升沿时间:
$$
tr = t2-t1 = 0.8473RC
$$
可推出上拉电阻的公式
$$
R_{p(max)}=\frac{t_r}{0.8473C_b}
$$

### 上拉电阻取值 min

#### 图像法

电源电压限制电阻Rp的最小值，因为标准模式和快速模式的额定最小吸电流为3 mA，快速增强模式为20 mA。![image-20231026222918564](硬件培训 stm32外围电路.assets/image-20231026222918564.png)

#### 计算法

$$
R_{p(min)}=\frac{V_{DD}-V_{OL(max)}}{I_{OL}}
$$

式中，Rp（min）为上拉电阻最小值，单位Ω；VDD电源电压，单位V；Vol（max）为输出低电平时的电压，单位V，在标准模式、快速模式和快速增强模式对应总线电气特征表中给出了值；Iol为输出低电平时的灌电流，单位A，在标准模式、快速模式和快速增强模式对应总线电气特征表中给出了值。

（很显然的，图像法显然的快，但正常谁想算啊，正常人直接百度一下开抄）

### 解决总线电容Cb过大方法

总线电容限值用于限制上升时间的减少，以满足在额定传输频率。虽然大多数设计可以轻松保持在这一限制范围内，但有些应用可能会超过这一限制。可以采用以下几种方法来应对过大的总线电容：

①降低fSCL频率：总线以较低的速度运行(较低的fSCL)。

②增加输出驱动能力：可以使用驱动电流更高的器件，如额定为快速模式增强的器件(PCA96xx)。

③使用总线缓冲器：有许多总线缓冲器件可以将总线分成若干段，使每段的电容低于容许限值，例如PCA9517总线缓冲器或PCA9546A开关。

④增加开关上拉电路：开关上拉电路可用于加速上升沿，方法是在需要时交替切换低值上拉电阻的输入和输出。

#### 降低fSCL频率

要确定允许的较低总线工作频率，首先要找到总线上限制最大（运行速度最低）的器件的tLOW和tHIGH。有关这些值，请参考各个器件的数据表。实际上升时间(tr)取决于RC时间常数。最大限制下降时间(tf)取决于总线上的最低输出驱动。确保考虑到任何具有最小tr或tf的器件。
$$
f_{max}=\frac{1}{t_{LOW(min)}+t_{r(actual)}+t_{r(actual)}+t_{f(actual)}}
$$
式中，fmax为运行工作频率上限，单位是s；tLow(min)为SCL低电平保持最小时间，单位s；tHIGH(min)为SCL高电平保持最小时间，单位s；tr（actual）为SCL上升沿实际时间，单位s；tf（actual）为SCL下降沿实际时间，单位s。

备注：如果总线很长，还必须考虑信号的飞行时间。

实际结果可能更慢，因为实际运行时不会准确地将tLOW和tHIGH分别控制在30 %至70 %或70 %至30 %的最小值。

#### 增强输出驱动能力

如果使用PCA96xx Fast-mode Plus或P82B总线缓冲器等更高驱动器件，则更高强度的输出驱动器会吸收更多电流，导致边沿速率显著加快，也就允许更高的总线电容。参考相关的总线上电气特征参数，使用Cb、Rp、tr和tf的实际值进行计算，以确定最大频率。

#### 增加总线缓冲器、多路复用器和开关

另一种解决总线电容过大的方法是使用总线缓冲器、多路复用器或开关将总线分成更小的段。下图显示了一个使用PCA9515缓冲器处理总线电容过大的示例。然后允许每个段具有最大电容，因此总线可以具有两倍的最大电容。请记住，添加缓冲总是会增加延迟——缓冲延迟，加上到每个边沿的额外转换时间，这降低了最大工作频率，并且还可能引入特殊的VIL和VOL考虑。

有关这方面的应用和恩智浦半导体器件的更多信息，请参考AN 255（I2C / SMBus中继器、集线器和扩展器）和AN262（PCA 954 x系列I2C/SMBus多路复用器和开关）的应用。

![image-20231026224802171](硬件培训 stm32外围电路.assets/image-20231026224802171.png)

#### 增加开关上拉电路

电源电压(VDD)和最大输出低电平决定上拉电阻Rp的最小值。例如，当电源电压为VDD = 5V±10%，VOL(max) = 0.4 V、电流为3 mA时，Rp(min)=(5.5-0.4)/0.003 = 1.7kΩ。如上图像法，Rp=1.7KΩ值将最大总线电容限制在200 pF左右，以满足300 ns的最大tr要求。如果总线电容高于此值，就可以使用如下图的开关上拉电路

![image-20231026225535460](硬件培训 stm32外围电路.assets/image-20231026225535460.png)

图中的开关上拉电路适用于VDD = 5V±10%的电源电压和400 pF的最大容性负载。由于它是由总线电平控制的，因此不需要额外的开关控制信号。在上升/下降沿期间，HCT4066中的双向开关在0.8 V至2.0 V的总线电平下开启/关闭上拉电阻Rp2，组合电阻Rp1和Rp2可以在300 ns的最大额定上升时间(tr)内上拉总线。

串联电阻rs是可选的。它们保护I2C总线设备的I/O级免受总线线路上高压尖峰的影响，并将总线线路信号的串扰和下冲降至最低。Rs的最大值由当总线切换到低电平以关闭Rp2时该电阻上的最大允许压降决定。

此外，有些总线缓冲器内部集成了上升时间加速器。也有一些独立的上升时间加速器器件可供选用。

### 串联保护电路取值

串联电阻(Rs)可用于防止SDA和SCL线路上的高压尖峰(例如，由电视显像管的闪烁引起)。如果使用串联电阻，必须将Rs电阻加入Rp和容许总线电容Cb的计算中。

![image-20231026230239663](硬件培训 stm32外围电路.assets/image-20231026230239663.png)

低电平所需的0.1VDD噪声裕量限制了Rs的最大值。Rs(max)与Rp的函数关系如图所示。请注意，串联电阻会影响输出下降时间。

![image-20231026230309671](硬件培训 stm32外围电路.assets/image-20231026230309671.png)

### 输入漏电流

每个连接到I2C的器件的最大高电平输入电流的额定最大值为10 μA，由于高电平要求0.2VDD的噪声裕量，该输入电流限制了Rp的最大值。这个限制取决于VDD。总的高电平输入电流与最大上拉电阻Rp(max)之间的函数关系如图

![image-20231026230917230](硬件培训 stm32外围电路.assets/image-20231026230917230.png)

### 总线走线方式

一般来说，必须优化I2C布线方式，以便将总线线路的串扰和干扰降至最低。由于上拉器件的阻抗相对较高，总线最容易受到高电平串扰和干扰的影响。

如果PCB或带状电缆上的总线长度超过10 cm，并且包括VDD和VSS线，则布线方式式应为：

![image-20231026231048002](硬件培训 stm32外围电路.assets/image-20231026231048002.png)

如果没有VDD线，只有VSS线，走线方式应为：

![image-20231026231106407](硬件培训 stm32外围电路.assets/image-20231026231106407.png)

这些布线方式还会导致SDA和SCL线路具有相同的容性负载。如果PCB板设计时有单独的VDD层和VSS参考层，则可以省略VSS和VDD线。

如果总线是双绞线，每条总线必须与VSS回路绞合。或者，SCL线可以与VSS回路绞合，SDA线与VDD回路绞合。在后一种情况下，必须使用电容将双绞线两端的VDD线与VSS线相连，以达到去耦的目的。

如果总线线路被屏蔽(屏蔽层连接到VSS)，干扰将降至最低。但是，尽量使屏蔽电缆与SDA、屏蔽电缆和SCL线之间的分布等效电容最小，以最大限度地降低串扰。

参考

[如何计算I2C上拉电阻、I2C串联电阻、I2C总线电容？ (baidu.com)](https://baijiahao.baidu.com/s?id=1732313007711468785&wfr=spider&for=pc)

### 经验值

![image-20231026231635488](硬件培训 stm32外围电路.assets/image-20231026231635488.png)

不想动脑可以抄

## SPI电路设计

### 低速情况

![image-20231027210041602](硬件培训 stm32外围电路.assets/image-20231027210041602.png)

线短速慢你可以这么直接连连看

### 高速

![image-20231027212424228](硬件培训 stm32外围电路.assets/image-20231027212424228.png)

#### 匹配电阻

考虑spi信号上升时间tr与传输时间tp进行对比
$$
t_p=\frac{L}{V}
$$
其中L是导线长度，V是电磁波在电路板中的传输速度 V=C/sqrDk，其中Dk是光速衰减因子，对于电路板而言是铜线，Dk=4

当tp>0.1tr时，spi总线需要按照传输线来设计.举一个具体的例子，如果SPI的时钟信号上升时间为10ns，导线长度是15cm，这样计算下来tp/tr是大于0.1，此时就需要按照传输线设计，要进行阻抗匹配。

传输线匹配的两种常见放大，就是在信号输出端串联电阻匹配，或者在接收端并联电阻匹配。在接收端并联电阻匹配的弊端：当并联电阻接地下拉或者接电源上拉时候，都会增加驱动器损耗。因此常用的方法还是前者。除此之外，SPI的PCB设计，需要按照高速PCB布线原则来设计，确定好走线的特征阻抗，计算好走线宽度，间隔等参数。特征阻抗一般选择50欧姆或者90欧姆等等。设计好了PCB的特征阻抗，串联电阻就好选择了，一般驱动器的输出阻抗Ro在10-30欧姆之间，传输线设计的阻抗是50欧姆，那么串联的电阻Zl可以选择22欧姆或者33欧姆。Zl和输出阻抗Ro相加，就和传输线特征阻抗相等

#### 一些建议

如果SPI总线速度较慢，可以使用一些非常简单的指南来防止一些基本的信号完整性问题。可以实施以同时减少电感（导致振铃）、串扰和辐射发射的一些最简单的指南包括：

将SPI线路布置在地平面上，即使它们不是高速的

在薄电介质上使用更宽的走线：外层的尺寸是下一层到GND距离的2-2.5倍；内层上10-15 mil的走线通常很好（线能粗则粗，能短则短。减小线路寄生电容，电感）

如果使用的是2层板并且没有空间放置接地层，则在SPI线周围放置接地以提供清晰的返回路径（严格用地包络屏蔽），为了获得最佳性能，我建议不要使用2层，而是从与高速数字设计兼容的PCB叠层开始。

pcb可以走弧形线就走弧形线

如果要求严格的话，可以把时钟线和数据线分开

## CAN电路设计

电路设计没什么说的，关键就是根据通信速率选个芯片

设计参考ISO标准

ISO11898 是通信速度为 125kbps-1Mbps 的 CAN 高速通信标准。

ISO11519 是通信速度为 125kbps 以下的 CAN 低速通信标准。

建议自学学习，不过估计也是选好芯片然后开抄

pcb布线要求走等长差分线

省流：ISO11898标准规定互连为具有120-Ω特性阻抗（ZO）的单根双绞线(屏蔽或非屏蔽）。应使用等于线路特性阻抗的电阻来终止电缆的两端--120Ω电阻终端，以防止信号反射。在ISO11898-2中，驱动器差动输出规定为60Ω负载（两个120Ω终端电阻并联），且差动输出必须大于1.5 V。--手册中测试电路的60Ω电阻应该是ISO11898-2标准，实际应用120Ω多。

## UART电路设计

好像也没啥讲的，连连看

贴上三个应用电路水一下

![在这里插入图片描述](硬件培训 stm32外围电路.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzE1Njc3MDEx,size_16,color_FFFFFF,t_70-1698414434566-3.png)

![在这里插入图片描述](硬件培训 stm32外围电路.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzE1Njc3MDEx,size_16,color_FFFFFF,t_70-1698414447920-6.png)

![在这里插入图片描述](硬件培训 stm32外围电路.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzE1Njc3MDEx,size_16,color_FFFFFF,t_70.png)